# Анализ проекта Questions Breakdown

**Дата анализа:** 2025-11-14
**Версия:** 1.0

---

## Оглавление
1. [Обзор проекта](#обзор-проекта)
2. [Критические проблемы](#критические-проблемы)
3. [Серьезные проблемы](#серьезные-проблемы)
4. [Средние проблемы](#средние-проблемы)
5. [Мелкие проблемы](#мелкие-проблемы)
6. [Архитектурные проблемы](#архитектурные-проблемы)
7. [Рекомендации по улучшению](#рекомендации-по-улучшению)

---

## Обзор проекта

### Назначение
Система автоматического разбиения задач на подзадачи с использованием OpenAI GPT API. Проект позволяет рекурсивно разбивать сложные задачи на иерархию простых шагов.

### Структура проекта
```
questions_breakdown/
├── main.py                  # Основной модуль разбиения задач
├── print_rezults.py         # Утилита визуализации результатов
├── helpers/
│   ├── run_checks.sh        # Проверка синтаксиса
│   └── data/
│       └── sample_query.txt # Пример запроса
├── run.sh                   # Скрипт запуска (Linux/macOS)
├── run.ps1                  # Скрипт запуска (Windows)
├── AGENTS.md                # Описание проекта
├── project-overview.yaml    # YAML конфигурация (несоответствует проекту!)
└── project-tracker.yaml     # YAML трекер (несоответствует проекту!)
```

---

## Критические проблемы

### 1. Устаревшее OpenAI API (КРИТИЧНО)
**Файл:** `main.py:283`

**Проблема:**
```python
response = openai.ChatCompletion.create(
    model=model,
    messages=messages,
    functions=functions,
    function_call={"name": "task_brakedown"},
    temperature=temperature
)
```

**Описание:**
- Используется устаревший способ вызова API OpenAI
- Библиотека openai >= 1.0.0 требует использования нового клиента
- Код **не будет работать** с современными версиями библиотеки
- Параметр `functions` устарел, нужно использовать `tools`

**Последствия:**
- Приложение не запускается с новыми версиями openai
- При обновлении зависимостей код сломается

**Как исправить:**
```python
from openai import OpenAI

client = OpenAI(api_key=getenv("gpt_api"))
response = client.chat.completions.create(
    model=model,
    messages=messages,
    tools=[{
        "type": "function",
        "function": functions[0]
    }],
    tool_choice={"type": "function", "function": {"name": "task_brakedown"}},
    temperature=temperature
)
```

---

### 2. Полное несоответствие документации и реализации (КРИТИЧНО)
**Файлы:** `project-overview.yaml`, `project-tracker.yaml`

**Проблема:**
- YAML файлы описывают проект **"telebot-constructor"** - платформу для создания Telegram ботов
- Реальный код - **"questions_breakdown"** - система разбиения задач через GPT
- 100% несоответствие между документацией и кодом

**Последствия:**
- Невозможно понять назначение проекта из документации
- Вводит в заблуждение новых разработчиков
- Теряется контекст разработки

---

### 3. Отсутствие файла зависимостей (КРИТИЧНО)
**Отсутствует:** `requirements.txt`

**Проблема:**
- Нет файла с зависимостями Python
- Невозможно воспроизвести окружение
- Неясно, какие версии библиотек требуются

**Используемые библиотеки (из кода):**
```
openai
python-dotenv
chardet
```

**Последствия:**
- Невозможно запустить проект "из коробки"
- Проблемы с развертыванием
- Конфликты версий библиотек

---

## Серьезные проблемы

### 4. Ошибка в required полях функции (main.py:267)
**Файл:** `main.py:267`

**Проблема:**
```python
"required": ["step1", "step2", "step3", "step4", "step5, step6, step7, step8, step9, step10"],
```

**Описание:**
- Строка `"step5, step6, step7, step8, step9, step10"` является одним элементом
- Должны быть отдельные элементы массива
- OpenAI API не сможет корректно валидировать ответ

**Как исправить:**
```python
"required": ["step1", "step2", "step3", "step4", "step5", "step6", "step7", "step8", "step9", "step10"],
```

---

### 5. Систематические опечатки в коде
**Файлы:** `main.py`, `print_rezults.py`

**Проблемы:**
| Неправильно | Правильно | Где встречается |
|-------------|-----------|-----------------|
| `brakedown` | `breakdown` | Везде в коде (функции, переменные, комментарии) |
| `rezults` | `results` | Имя файла `print_rezults.py` |
| `futher` | `further` | `need_futher_breakdown` (строки 49, 95, 124, и т.д.) |

**Последствия:**
- Непрофессиональный вид кода
- Проблемы при поиске по кодовой базе
- Несоответствие naming conventions
- Сложность для англоговорящих разработчиков

---

### 6. Хардкод значений в коде (main.py:14-22)
**Файл:** `main.py:14-22`

**Проблема:**
```python
model = "gpt-3.5-turbo"
max_depth = 1
max_gpt4_depth = 0
time_prefix = time()
query = "Как сделать лодку из дерева (немного плотничаю и слесарничаю)"
#"Разработай подробнейший план создания художественного произведения..."
#"Как разработать расписание для занятий Английским маме 3-х детей..."
#"Как изучить Английский самостоятельно..."
temperature=0.9
```

**Описание:**
- Дефолтные значения заданы в глобальной области
- Несколько закомментированных примеров запросов (мертвый код)
- Плохая практика: смешивание кода и данных

**Последствия:**
- Трудно менять дефолтные значения
- Загромождение кода
- При запуске без аргументов будет использован хардкод-запрос

---

### 7. Недостаточная обработка ошибок (main.py:290-294)
**Файл:** `main.py:290-294`

**Проблема:**
```python
except Exception as e:
    print(f"Exception: {e}")
    save_to_file(f"Error: {e}", f'middle_results/...')
    return {}
```

**Описание:**
- Слишком широкий `except Exception`
- Не логируется traceback
- Возвращается пустой словарь без индикации ошибки
- Ошибка только печатается, не выбрасывается дальше

**Последствия:**
- Сложно дебажить проблемы
- Тихий провал при ошибках API
- Потеря контекста ошибки

---

### 8. Глобальное изменяемое состояние (main.py:37)
**Файл:** `main.py:37`

**Проблема:**
```python
all_steps: set[str] = set()
```

**Описание:**
- Глобальная переменная для отслеживания уникальности шагов
- При параллельных запусках может вызвать race conditions
- Нарушает принцип изоляции вызовов

**Последствия:**
- Невозможно запускать несколько задач параллельно
- Утечка памяти при длительной работе
- Проблемы при использовании в веб-сервисе

---

## Средние проблемы

### 9. Избыточность функции decode_string (main.py:55-74)
**Файл:** `main.py:55-74`

**Проблема:**
```python
def decode_string(encoded_str):
    # Проверка типа входных данных
    if isinstance(encoded_str, str):
        try:
            encoded_str = bytes(encoded_str, 'utf-8')
        except Exception as e:
            return str(e)

    detected_info = chardet.detect(encoded_str)
    # ...
```

**Описание:**
- OpenAI API возвращает корректный UTF-8
- Использование chardet избыточно
- Функция может быть источником дополнительных ошибок

**Рекомендация:**
Удалить функцию и напрямую работать со строками из API.

---

### 10. Неэффективная структура function schema (main.py:108-269)
**Файл:** `main.py:108-269`

**Проблема:**
- 162 строки дублирующегося кода для step1-step10
- Можно заменить на массив объектов
- Нарушение DRY принципа

**Пример дублирования:**
```python
"step1": {
    "type": "object",
    "description": "first step",
    "properties": { ... },
    "required": ["step", "need_futher_breakdown"],
},
"step2": {
    "type": "object",
    "description": "second step",
    "properties": { ... },  # ТОЧНО ТАКИЕ ЖЕ
    "required": ["step", "need_futher_breakdown"],
},
# ... еще 8 раз
```

**Рекомендация:**
Использовать динамическую генерацию schema или массив steps.

---

### 11. Мертвый код (main.py:80-107, 310-314)
**Файл:** `main.py:80-107, 310-314`

**Проблема:**
```python
"""{
  "name": "task_brakedown",
  "description": "...",
  ...
}
"""
# Огромный закомментированный блок кода

"""try:
    steps = json.loads(function_call_args)
    steps = steps["steps"]
except json.JSONDecodeError:
    steps = {}"""
```

**Описание:**
- Большие блоки закомментированного кода
- Старые реализации не удалены
- Загромождает читаемость

---

### 12. Проблемы с логикой условий (main.py:336)
**Файл:** `main.py:336`

**Проблема:**
```python
if steps and len(steps) > 1:
    kwargs = task_brakedown(...)
    return kwargs
return {}
```

**Описание:**
- Если получен ровно 1 шаг, он игнорируется
- Нелогичное поведение: почему 1 шаг не обрабатывается?
- Должно быть `>= 1` или просто `if steps:`

---

### 13. Небезопасное использование переменной окружения (main.py:38)
**Файл:** `main.py:38`

**Проблема:**
```python
openai.api_key = getenv("gpt_api")
```

**Описание:**
- Нет проверки наличия ключа
- При отсутствии `.env` или переменной - `None`
- Ошибка проявится только при вызове API

**Как исправить:**
```python
api_key = getenv("gpt_api")
if not api_key:
    raise ValueError("Environment variable 'gpt_api' is not set")
openai.api_key = api_key
```

---

### 14. Проблемы с логированием (main.py:25)
**Файл:** `main.py:25`

**Проблема:**
```python
logging.basicConfig(filename='app.log', filemode='w', ...)
```

**Описание:**
- `filemode='w'` перезаписывает лог при каждом запуске
- Логируются только ERROR уровня
- Нет структурированных логов
- Отсутствует ротация логов

**Последствия:**
- Потеря истории логов
- Сложность отладки
- Нет информации о нормальной работе

---

### 15. Неоптимальные имена файлов результатов (main.py:382-383)
**Файл:** `main.py:382-383`

**Проблема:**
```python
filename_prefix = f"results/{query[:40]}_{model}_t{temperature}_{time()}"
```

**Описание:**
- Обрезка запроса до 40 символов может создать коллизии
- Использование времени с точностью до микросекунд избыточно
- Нет валидации символов файловой системы (могут быть `/`, `\`, и т.д.)

**Риски:**
- Проблемы с файловыми системами (спецсимволы в именах)
- Сложность поиска результатов

---

## Мелкие проблемы

### 16. Inconsistent naming (main.py)
**Примеры:**
- `task_brakedown` - snake_case
- `Breakdown` - PascalCase
- Смешивание стилей именования

**Рекомендация:**
Следовать PEP 8:
- Функции: `snake_case`
- Классы: `PascalCase`

---

### 17. Отсутствие docstrings (main.py:45, 76)
**Проблема:**
Только одна функция имеет docstring (`print_steps`)

**Последствия:**
- Сложность понимания кода
- Нет автодокументации
- Проблемы с IDE подсказками

---

### 18. Неиспользуемые параметры (main.py:360)
**Файл:** `main.py:360`

```python
def print_steps(json_data, indent=0, prefix='', file=None):
    # параметр indent используется только в рекурсии
    # но не влияет на результат
```

**Описание:**
Параметр `indent` передается, но фактически не используется для отступов.

---

### 19. Отсутствие .gitignore для результатов
**Проблема:**
- Директории `results/`, `middle_results/`, `logs/` должны быть в `.gitignore`
- Файл `app.log` тоже должен игнорироваться
- `.env` файл уже в `.gitignore` (хорошо)

---

### 20. run.sh проблемы (run.sh:57, 75-76)
**Файл:** `run.sh`

**Проблемы:**
- Скрипт пытается делать `git pull` без проверки текущего состояния
- Запуск `main.py` без передачи аргументов
- Нет проверки наличия Python

---

## Архитектурные проблемы

### 21. Монолитная функция Breakdown
**Описание:**
Функция `Breakdown` делает слишком много:
- Формирует запрос к API
- Обрабатывает ответ
- Сохраняет промежуточные результаты
- Управляет рекурсией

**Рекомендация:**
Разбить на отдельные функции:
- `create_api_request()`
- `call_openai_api()`
- `parse_api_response()`
- `save_intermediate_results()`
- `recursive_breakdown()`

---

### 22. Отсутствие слоя абстракции для API
**Проблема:**
- Прямой вызов OpenAI API вшит в логику
- Невозможно легко переключиться на другую модель/провайдера
- Сложно мокировать для тестов

**Рекомендация:**
Создать класс `LLMClient` с интерфейсом.

---

### 23. Отсутствие конфигурации через файл
**Проблема:**
- Все настройки через аргументы командной строки или хардкод
- Нет `config.yaml` или `settings.py`

**Рекомендация:**
Использовать `pydantic-settings` или `dynaconf`.

---

### 24. Отсутствие тестов
**Критическая проблема:**
- Нет unit-тестов
- Нет интеграционных тестов
- `run_checks.sh` только проверяет синтаксис

**Рекомендация:**
Добавить тесты с использованием `pytest`:
```
tests/
├── test_breakdown.py
├── test_print_results.py
└── conftest.py
```

---

### 25. Отсутствие type hints
**Проблема:**
Только одна type hint во всем коде:
```python
all_steps: set[str] = set()
```

**Последствия:**
- Нет проверки типов через mypy
- Отсутствие автодополнения в IDE
- Сложность понимания интерфейсов

---

### 26. Отсутствие ограничения на стоимость API
**Проблема:**
- Нет ограничения на количество рекурсивных вызовов
- Нет подсчета использованных токенов
- Можно случайно потратить много денег

**Рекомендация:**
Добавить:
- Максимальное количество вызовов API
- Подсчет и логирование токенов
- Бюджет на выполнение задачи

---

## Рекомендации по улучшению

### Немедленные действия (высокий приоритет)

1. **Обновить OpenAI API клиент**
   - Перейти на новый клиент OpenAI
   - Обновить все вызовы API

2. **Создать requirements.txt**
   ```
   openai>=1.0.0
   python-dotenv>=1.0.0
   chardet>=5.0.0
   ```

3. **Исправить опечатки**
   - Переименовать `print_rezults.py` → `print_results.py`
   - Заменить `brakedown` → `breakdown` везде
   - Заменить `futher` → `further` везде

4. **Исправить ошибку в required (main.py:267)**
   - Разделить строку на отдельные элементы

5. **Синхронизировать документацию**
   - Обновить `project-overview.yaml`
   - Обновить `project-tracker.yaml`
   - Или удалить их, если они не нужны

### Краткосрочные улучшения

6. **Добавить валидацию входных данных**
   - Проверка наличия API ключа
   - Валидация параметров

7. **Улучшить обработку ошибок**
   - Специфичные exceptions
   - Логирование с traceback
   - Graceful degradation

8. **Добавить .gitignore правила**
   ```
   results/
   middle_results/
   logs/
   app.log
   *.pyc
   __pycache__/
   ```

9. **Добавить базовые тесты**
   - Unit-тесты для основных функций
   - Mock для OpenAI API

10. **Рефакторинг function schema**
    - Удалить дублирование кода
    - Использовать динамическую генерацию

### Долгосрочные улучшения

11. **Архитектурный рефакторинг**
    - Разделить монолитную функцию
    - Создать слой абстракции для LLM
    - Добавить dependency injection

12. **Добавить type hints**
    - Полное покрытие типами
    - Настроить mypy

13. **Улучшить логирование**
    - Структурированные логи (JSON)
    - Ротация логов
    - Разные уровни логирования

14. **Добавить кэширование**
    - Кэш результатов API
    - Дедупликация запросов

15. **Создать CLI интерфейс**
    - Использовать `click` или `typer`
    - Интерактивный режим
    - Progress bar для длительных операций

16. **Добавить мониторинг**
    - Подсчет использованных токенов
    - Стоимость выполнения
    - Время выполнения

17. **Документация**
    - README.md с примерами
    - API документация
    - Архитектурная диаграмма

---

## Итоговая оценка

### Статистика проблем
- **Критические:** 3
- **Серьезные:** 5
- **Средние:** 7
- **Мелкие:** 5
- **Архитектурные:** 6

**Общее количество проблем:** 26

### Общий вердикт
Проект находится в **раннем прототипе** состоянии с множеством технических долгов. Код **функционален**, но требует серьезного рефакторинга перед использованием в продакшене.

### Оценка качества кода: 3/10

**Что хорошо:**
- ✅ Базовая функциональность работает
- ✅ Есть argparse для CLI
- ✅ Промежуточные результаты сохраняются
- ✅ API ключ не хардкоден

**Что критично исправить:**
- ❌ Обновить OpenAI API
- ❌ Создать requirements.txt
- ❌ Синхронизировать документацию
- ❌ Исправить опечатки
- ❌ Добавить тесты

---

## Приложение: Карта технического долга

```
┌─────────────────────────────────────────┐
│         ТЕХНИЧЕСКИЙ ДОЛГ                │
├─────────────────────────────────────────┤
│ Критический (3):                        │
│ • Устаревший OpenAI API                 │
│ • Нет requirements.txt                  │
│ • Документация не соответствует коду    │
├─────────────────────────────────────────┤
│ Серьезный (5):                          │
│ • Ошибка в required полях               │
│ • Систематические опечатки              │
│ • Хардкод значений                      │
│ • Плохая обработка ошибок               │
│ • Глобальное изменяемое состояние       │
├─────────────────────────────────────────┤
│ Средний (7):                            │
│ • Избыточность decode_string            │
│ • Неэффективная schema структура        │
│ • Мертвый код                           │
│ • Проблемы с логикой условий            │
│ • Небезопасные env переменные           │
│ • Проблемы с логированием               │
│ • Неоптимальные имена файлов            │
└─────────────────────────────────────────┘
```

---

**Подготовлено:** Claude Code Analyzer
**Версия анализатора:** 1.0
**Дата:** 2025-11-14
